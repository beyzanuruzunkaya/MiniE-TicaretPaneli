@model List<MiniE_TicaretPaneli.Models.ShoppingCart>
@{
    ViewData["Title"] = "Sepetim";
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Sepetten ürün silme onayı
        document.querySelectorAll('.remove-from-cart-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const form = btn.closest('form');
                const itemName = btn.getAttribute('data-item-name') || 'Bu ürünü';
                Swal.fire({
                    title: 'Emin misiniz?',
                    text: itemName + ' sepetten kaldırılsın mı?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Evet, kaldır!',
                    cancelButtonText: 'Vazgeç'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });
        });

        // Sepeti temizleme onayı
        document.querySelectorAll('.clear-cart-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const form = btn.closest('form');
                Swal.fire({
                    title: 'Emin misiniz?',
                    text: 'Sepetinizdeki tüm ürünler silinecek. Bu işlem geri alınamaz!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Evet, temizle!',
                    cancelButtonText: 'Vazgeç'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });
        });
    });

    // Miktar güncelleme fonksiyonu
    function updateQuantity(cartItemId, change) {
        const quantityInput = document.getElementById('quantity-' + cartItemId);
        let currentQuantity = parseInt(quantityInput.value);
        let newQuantity = currentQuantity + change;
        
        // Minimum 1 olmalı
        if (newQuantity < 1) {
            newQuantity = 1;
        }
        
        // Stok kontrolü
        const maxStock = parseInt(quantityInput.getAttribute('max'));
        if (newQuantity > maxStock) {
            Swal.fire({
                title: 'Stok Yetersiz!',
                text: 'Bu ürün için yeterli stok bulunmamaktadır.',
                icon: 'warning',
                confirmButtonText: 'Tamam'
            });
            return;
        }
        
        // AJAX ile güncelleme
        const formData = new FormData();
        formData.append('cartItemId', cartItemId);
        formData.append('newQuantity', newQuantity);
        formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
        
        fetch('/Customer/Cart/UpdateCartItem', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                // Sayfayı yenile
                window.location.reload();
            } else {
                Swal.fire({
                    title: 'Hata!',
                    text: 'Miktar güncellenirken bir hata oluştu.',
                    icon: 'error',
                    confirmButtonText: 'Tamam'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Hata!',
                text: 'Miktar güncellenirken bir hata oluştu.',
                icon: 'error',
                confirmButtonText: 'Tamam'
            });
        });
    }

    // Beden güncelleme fonksiyonu
    function updateSize(cartItemId, newSize) {
        const formData = new FormData();
        formData.append('cartItemId', cartItemId);
        formData.append('newSize', newSize);
        formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
        
        fetch('/Customer/Cart/UpdateCartItemSize', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                // Sayfayı yenile
                window.location.reload();
            } else {
                Swal.fire({
                    title: 'Hata!',
                    text: 'Beden güncellenirken bir hata oluştu.',
                    icon: 'error',
                    confirmButtonText: 'Tamam'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Hata!',
                text: 'Beden güncellenirken bir hata oluştu.',
                icon: 'error',
                confirmButtonText: 'Tamam'
            });
        });
    }
    </script>
}

<div class="container mt-4">
    @Html.AntiForgeryToken()
    <h2 class="text-center mb-4">Sepetim</h2>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model == null || !Model.Any())
    {
        <div class="text-center py-5">
            <div class="alert alert-info">
                <h4>Sepetinizde ürün bulunmamaktadır.</h4>
                <p>Alışverişe başlamak için <a href="/Customer/Product/Products" class="alert-link">ürünler sayfasına</a> gidin.</p>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-8">
                @foreach (var item in Model)
                {
                    <div class="card mb-3">
                        <div class="row g-0">
                            <div class="col-md-3">
                                @if (!string.IsNullOrEmpty(item.Product?.ImageUrl))
                                {
                                    <a href="/Customer/Product/ProductDetail/@item.ProductId" 
                                       class="text-decoration-none"
                                       title="Ürün detayını görüntüle">
                                        <img src="@item.Product.ImageUrl" 
                                             class="img-fluid rounded-start product-image-link" 
                                             alt="@item.Product.Name" 
                                             style="height: 200px; object-fit: cover; transition: transform 0.2s;">
                                    </a>
                                }
                                else
                                {
                                    <a href="/Customer/Product/ProductDetail/@item.ProductId" 
                                       class="text-decoration-none"
                                       title="Ürün detayını görüntüle">
                                        <div class="bg-light d-flex align-items-center justify-content-center product-image-link" 
                                             style="height: 200px; transition: transform 0.2s;">
                                            <span class="text-muted">Resim Yok</span>
                                        </div>
                                    </a>
                                }
                            </div>
                            <div class="col-md-9">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <a href="/Customer/Product/ProductDetail/@item.ProductId" 
                                               class="text-decoration-none text-dark product-link"
                                               title="Ürün detayını görüntüle">
                                                <h5 class="card-title">
                                                    @item.Product?.Name
                                                    <i class="fas fa-external-link-alt ms-1 text-muted" style="font-size: 0.8rem;"></i>
                                                </h5>
                                            </a>
                                            <p class="card-text text-muted">@item.Product?.Description</p>
                                            
                                            <div class="row mb-2">
                                                <div class="col-md-6">
                                                    <strong>Beden:</strong> @item.SelectedSize
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Fiyat:</strong> ₺@item.Product?.Price.ToString("N2")
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="quantity-@item.Id" class="form-label">Miktar:</label>
                                                    <div class="input-group" style="width: 120px;">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(@item.Id, -1)">-</button>
                                                        <input type="number" class="form-control text-center" id="quantity-@item.Id" value="@item.Quantity" min="1" max="@item.Product?.Stock" readonly>
                                                        <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(@item.Id, 1)">+</button>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="size-@item.Id" class="form-label">Beden Değiştir:</label>
                                                    <select class="form-select" id="size-@item.Id" onchange="updateSize(@item.Id, this.value)">
                                                        @if (item.Product?.AvailableSizes != null)
                                                        {
                                                            var sizes = item.Product.AvailableSizes.Split(',');
                                                            foreach (var size in sizes)
                                                            {
                                                                var selected = size.Trim() == item.SelectedSize ? "selected" : "";
                                                                <option value="@size.Trim()" selected="@(size.Trim() == item.SelectedSize)">@size.Trim()</option>
                                                            }
                                                        }
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong>Toplam:</strong> ₺@((item.Quantity * item.Product?.Price ?? 0).ToString("N2"))
                                                </div>
                                                <div class="col-md-6">
                                                    <form asp-action="RemoveFromCart" method="post" style="display: inline;">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="cartItemId" value="@item.Id" />
                                                        <button type="button" class="btn btn-danger btn-sm remove-from-cart-btn" data-item-name="@item.Product?.Name">
                                                            <i class="fas fa-trash"></i> Kaldır
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Sepet Özeti</h5>
                    </div>
                    <div class="card-body">
                        @{
                            var totalItems = Model.Sum(item => item.Quantity);
                            var totalPrice = Model.Sum(item => item.Quantity * (item.Product?.Price ?? 0));
                        }
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Toplam Ürün:</span>
                            <span>@totalItems adet</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Toplam Tutar:</span>
                            <span class="fw-bold">₺@totalPrice.ToString("N2")</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-grid gap-2">
                            <a href="/Customer/Product/Products" class="btn btn-outline-primary">
                                <i class="fas fa-shopping-bag"></i> Alışverişe Devam Et
                            </a>
                            
                            @if (Model.Any())
                            {
                                <a href="/Customer/Checkout/Checkout" class="btn btn-success">
                                    <i class="fas fa-credit-card"></i> Ödemeye Geç
                                </a>
                                
                                <form asp-action="ClearCart" method="post">
                                    @Html.AntiForgeryToken()
                                    <button type="button" class="btn btn-outline-danger clear-cart-btn">
                                        <i class="fas fa-trash"></i> Sepeti Temizle
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .product-link:hover {
        color: #007bff !important;
        text-decoration: underline !important;
    }
    
    .product-image-link:hover {
        transform: scale(1.05) !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
    }
    
    .product-image-link {
        cursor: pointer;
    }
    
    .card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: box-shadow 0.3s ease;
    }
</style>